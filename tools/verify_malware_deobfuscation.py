
import os
import sys

# Add parent directory to path to import modules
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

from llm.deobfuscator_agent import DeobfuscatorAgent

def verify_file(filename):
    print(f"\n{'='*60}")
    print(f"üî¨ Testing Deobfuscation on: {filename}")
    print(f"{'='*60}")
    
    agent = DeobfuscatorAgent()
    
    if not os.path.exists(filename):
        print(f"‚ùå Error: {filename} not found.")
        return
        
    with open(filename, 'r') as f:
        obfuscated_code = f.read()
        
    print(f"üìÑ Input Size: {len(obfuscated_code)} chars")
    print(f"üìÑ Obfuscated Input Sample:\n{obfuscated_code[:200]}...\n")
    
    # 1. Test Deobfuscation
    print("1Ô∏è‚É£  Running deobfuscation tool...")
    deobfuscated = agent._run_deobfuscation_tool(obfuscated_code)
    used_llm_deobfuscation = False
    
    tool_success = deobfuscated != obfuscated_code
    
    if not tool_success:
        print("‚ùå Deobfuscation tool failed (no change).")
        
        if agent._is_likely_obfuscated(obfuscated_code):
            print("‚ö†Ô∏è  Code detected as obfuscated (heuristic). Attempting LLM Fallback...")
            deobfuscated = agent._llm_deobfuscate(obfuscated_code)
            used_llm_deobfuscation = True
        else:
            print("‚ÑπÔ∏è Code not detected as obfuscated (heuristic failed).")
    else:
        print("‚úÖ Deobfuscation tool successful (code changed).")
        
    print(f"\nüìÑ Deobfuscated Output Sample:\n{deobfuscated[:300]}...\n")
        
    # 2. Test LLM Refinement
    if not used_llm_deobfuscation and tool_success:
        print("2Ô∏è‚É£  Running LLM Refinement...")
        refined = agent._refine_with_llm(deobfuscated)
    else:
        refined = deobfuscated
        print("2Ô∏è‚É£  Skipping separate refinement (done by LLM or failed).")

    
    print("\nüìÑ Final Output Sample:")
    print("-" * 40)
    print(refined[:1000]) # First 1000 chars
    print("..." if len(refined) > 1000 else "")
    print("-" * 40)
    
    # Analysis
    print("\nüîç Checking for malicious signatures in output...")
    signatures = [
        "child_process", "exec", "spawn", "http", "https", "socket", 
        "eval", "function constructor", "base64", "Buffer", "fs.write"
    ]
    
    found = []
    for sig in signatures:
        if sig.lower() in refined.lower():
            found.append(sig)
            
    if found:
        print(f"‚ö†Ô∏è  Potential malicious indicators found: {', '.join(found)}")
    else:
        print("‚ÑπÔ∏è  No obvious malicious keywords in first 1000 chars (check full output).")

if __name__ == "__main__":
    verify_file("tmp/malware_test.js")
    # verify_file("tmp/malware_test_2.js") # Optional
